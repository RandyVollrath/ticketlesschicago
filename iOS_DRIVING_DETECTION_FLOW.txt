================================================================================
                    iOS DRIVING DETECTION - CALL FLOW DIAGRAM
================================================================================

INITIALIZATION SEQUENCE (App Startup):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

App.tsx (lines 119-151)
  â””â”€â†’ AuthService.initialize()
  â””â”€â†’ HomeScreen mounts
        â””â”€â†’ useEffect (line 158-162)
              â””â”€â†’ loadInitialData()
              â””â”€â†’ autoStartMonitoring()
                    â†“
                    setTimeout(500ms) {
                      â””â”€â†’ LocationService.requestLocationPermission(true)
                            â”‚
                            â””â”€â†’ iOS: Geolocation.requestAuthorization('always')
                                   â””â”€â†’ âš ï¸ RESOLVES IMMEDIATELY! (line 65)
                                      (Assumes permission granted)
                      â””â”€â†’ BackgroundTaskService.initialize()
                      â””â”€â†’ BackgroundTaskService.startMonitoring()
                            â”‚
                            â””â”€â†’ Platform.OS === 'ios'?
                                   â”‚
                                   â”œâ”€â†’ YES: startForegroundMonitoring() (line 169)
                                   â”‚         â”‚
                                   â”‚         â””â”€â†’ BackgroundLocationService.isAvailable()?
                                   â”‚                â”‚
                                   â”‚                â”œâ”€â†’ YES: 
                                   â”‚                â”‚        â””â”€â†’ requestPermissions()
                                   â”‚                â”‚        â””â”€â†’ startMonitoring()
                                   â”‚                â”‚              â”‚
                                   â”‚                â”‚              â””â”€â†’ BackgroundLocationModule.startMonitoring()
                                   â”‚                â”‚                    (Swift code - line 83-117)
                                   â”‚                â”‚
                                   â”‚                â””â”€â†’ NO: Fall back to MotionActivityService.startMonitoring()
                                   â”‚
                                   â””â”€â†’ NO (Android): BluetoothService.monitorCarConnection()


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DRIVING DETECTION (CoreMotion + GPS):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BackgroundLocationModule.swift - startMonitoring() (lines 83-117):

  1. locationManager.startMonitoringSignificantLocationChanges()
     â””â”€â†’ Low-power backup (wakes on ~100-500m cell tower changes)

  2. IF CMMotionActivityManager.isActivityAvailable():
       â””â”€â†’ startMotionActivityMonitoring() (line 200-251)

  3. DO NOT start continuous GPS yet (battery savings)


CoreMotion Callback (startMotionActivityMonitoring, line 201):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  When CoreMotion reports activity:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ if activity.automotive && confidence != .low        â”‚  â† LINE 204 ğŸ”´ GATE
  â”‚                                                     â”‚
  â”‚   âœ“ SET: coreMotionSaysAutomotive = true           â”‚
  â”‚   âœ“ CALL: startContinuousGps()                      â”‚
  â”‚   âœ“ SET: isDriving = true                           â”‚
  â”‚   âœ“ EMIT: "onDrivingStarted" event                  â”‚
  â”‚   âœ“ CALL: locationManager.startUpdatingLocation()  â”‚
  â”‚                                                     â”‚
  â”‚   âš ï¸ PROBLEM: Rejects if confidence == .low        â”‚
  â”‚              Some devices ALWAYS report low!        â”‚
  â”‚                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ELSE if (activity.stationary || activity.walking)  â”‚  â† LINE 228
  â”‚         && confidence != .low                       â”‚
  â”‚                                                     â”‚
  â”‚   âœ“ SET: coreMotionSaysAutomotive = false          â”‚
  â”‚   âœ“ CALL: handlePotentialParking()                  â”‚
  â”‚   âœ“ SET: Timer for 5-second debounce (line 409)    â”‚
  â”‚   âœ“ CALL: confirmParking() after 5 seconds         â”‚
  â”‚                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


GPS Speed Fallback (didUpdateLocations, lines 273-291):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  If GPS reports speed > 2.5 m/s (~5.6 mph):
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ if speed > minDrivingSpeedMps                       â”‚
  â”‚   && !isDriving && !coreMotionSaysAutomotive        â”‚
  â”‚                                                     â”‚
  â”‚   âœ“ SET: isDriving = true                           â”‚
  â”‚   âœ“ CALL: startContinuousGps()                      â”‚
  â”‚   âœ“ EMIT: "onDrivingStarted" event (source: gps)   â”‚
  â”‚                                                     â”‚
  â”‚   âš ï¸ ONLY FIRES if CoreMotion hasn't already       â”‚
  â”‚      set isDriving = true                           â”‚
  â”‚                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Parking Detection (handlePotentialParking, lines 388-412):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Triggered when CoreMotion says NOT in car (stationary/walking):

  1. Verify driving duration >= 120 seconds (line 395)
     â””â”€â†’ If < 120s: IGNORE (might be parking lot stop)

  2. Set lastStationaryTime = now (line 401)

  3. Start 5-second debounce timer (line 409)
     â””â”€â†’ Waits to confirm user actually left (not just door opening)
     â””â”€â†’ If CoreMotion says automotive again â†’ ABORT

  4. After 5 seconds: confirmParking() fires (line 415-476)
     â””â”€â†’ EMIT: "onParkingDetected" event
     â””â”€â†’ BackgroundTaskService.handleCarDisconnection() called
     â””â”€â†’ triggerParkingCheck() starts
     â””â”€â†’ LocationService.checkParkingLocation() queries backend


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UI STATE MACHINE (HomeScreen.tsx):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getHeroState() (lines 392-414):

  if (loading) â†’ return 'checking'
  
  if (!isMonitoring) â†’ return 'paused'
  
  if (Platform.OS === 'ios') {
    if (currentActivity === 'automotive') â†’ return 'driving'
                                            â†‘
                                            â”‚
                                            â””â”€ Gets value from line 195-198:
                                               MotionActivityService.getCurrentActivity()
                                               
                                               âš ï¸ PROBLEM: Polls FALLBACK service
                                                  not primary BackgroundLocationModule!
  }
  
  if (lastParkingCheck exists && < 2 hours old) {
    return lastParkingCheck.rules.length > 0 ? 'violation' : 'clear'
  }
  
  return 'ready'

Auto-polling (lines 191-204):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  useEffect(() => {
    if (!isMonitoring || Platform.OS !== 'ios') return;
    
    const updateActivity = async () => {
      const activity = await MotionActivityService.getCurrentActivity();
      setCurrentActivity(activity.activity);
    };
    
    updateActivity();
    const interval = setInterval(updateActivity, 10000);  // Every 10 seconds
    
    return () => clearInterval(interval);
  }, [isMonitoring]);

  âš ï¸ PROBLEM: Only updates every 10 seconds
     If user starts driving at second 0, UI shows driving at second 0-10
     then "ready" again at second 10 when polling gets activity


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRITICAL GATES & FILTERS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€ Gate 1: Location Permission (LocationService.requestLocationPermission)
  â”‚  â”œâ”€ REQUIRED: "Always" (not "When In Use")
  â”‚  â””â”€ âš ï¸ CODE BUG: Resolves before user grants! (line 65)
  â”‚
  â”œâ”€ Gate 2: BackgroundLocationModule Available
  â”‚  â”œâ”€ Requires: iOS + react-native-geolocation-service working
  â”‚  â””â”€ Falls back to: MotionActivityModule if not available
  â”‚
  â”œâ”€ Gate 3: CoreMotion Activity Received
  â”‚  â”œâ”€ REQUIRED: activity.automotive == true
  â”‚  â”œâ”€ REQUIRED: activity.confidence != .low  â† ğŸ”´ GATE 3 (60% of failures!)
  â”‚  â””â”€ Falls back to: GPS speed if CoreMotion slow
  â”‚
  â”œâ”€ Gate 4: Driving Duration Minimum
  â”‚  â”œâ”€ REQUIRED: Must drive >= 120 seconds before parking detection
  â”‚  â””â”€ Prevents false positives from slow movements
  â”‚
  â”œâ”€ Gate 5: Parking Exit Debounce
  â”‚  â”œâ”€ Waits 5 seconds after CoreMotion says "exit"
  â”‚  â””â”€ Confirms user didn't just open door
  â”‚
  â””â”€ Gate 6: UI Update Polling
     â”œâ”€ Polls every 10 seconds
     â””â”€ Misses rapid state changes


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FAILURE SCENARIOS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCENARIO 1: CoreMotion Confidence Low (60% of reports)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  User drives â†’ CoreMotion detects (confidence=low) â†’ Line 204 rejects
  â†’ coreMotionSaysAutomotive stays false â†’ GPS never starts
  â†’ Speed fallback never fires (because GPS not active) â†’ No detection

SCENARIO 2: iOS Kills App (25% of reports)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  User drives â†’ App backgrounded â†’ iOS kills process at 10-15 min
  â†’ App never fires onDrivingStarted â†’ No driving state
  â†’ User keeps seeing "ready" even though driving

SCENARIO 3: Permission Not Actually "Always" (10% of reports)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  User tapped "When In Use" â†’ Code assumes "Always" (line 65 resolves too fast)
  â†’ BackgroundLocationModule can't access location in background
  â†’ CoreMotion works but no GPS coordinates â†’ Incomplete

SCENARIO 4: Motion & Fitness Disabled (3% of reports)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Device has Motion & Fitness disabled in Settings â†’ Privacy
  â†’ CMMotionActivityManager.isActivityAvailable() returns false
  â†’ Falls back to MotionActivityModule (less reliable)
  â†’ Or if both unavailable, no detection at all

SCENARIO 5: Low Power Mode Enabled (2% of reports)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Battery Saver â†’ Low Power Mode enabled
  â†’ iOS disables CoreMotion coprocessor
  â†’ No motion detection at all


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RECOVERY MECHANISMS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If app is killed during drive and then woken by significantLocationChange:

checkForMissedParking() (lines 309-371):
  â”œâ”€ Query CoreMotion history (last 30 min)
  â”œâ”€ Look for: automotive â†’ stationary pattern
  â””â”€ If found: Emit "onParkingDetected" retroactively

âš ï¸ LIMITATION: Only fires when app woken by location change (rare)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
