PROPERTY TAX SEARCH & ANALYSIS FLOW - PERFORMANCE BOTTLENECKS
============================================================

CURRENT PERFORMANCE: 30-80 seconds per analysis
TARGET PERFORMANCE: 15-25 seconds (40-60% faster)

=== TOP 10 BOTTLENECKS IDENTIFIED ===

1. EXCESSIVE PARALLEL API QUERIES (HIGHEST IMPACT)
   Location: /lib/cook-county-api.ts:1035-1136
   Problem: 5 parallel queries to same external API for condo comparables
           Each query 45-second timeout = 15-35 seconds added
   Quick Fix: Merge queries 2-4 into single API call
   Impact: Save 10-20 seconds

2. MISSING ANALYSIS RESULT CACHING (HIGH IMPACT)
   Location: /pages/api/property-tax/analyze.ts:71-121
   Problem: No caching of full analysis - repeat analysis = repeat 20 API calls
           Users refreshing page trigger complete re-analysis
   Quick Fix: Cache AppealOpportunity with 72-hour TTL
   Impact: Re-analysis latency <100ms

3. SEQUENTIAL BATCH UPSERTS (MEDIUM IMPACT)
   Location: /pages/api/property-tax/analyze.ts:183-219
   Problem: cacheComparables() does N individual upserts instead of batch
           15 comparables = 15 separate Supabase writes
   Quick Fix: Batch insert all records in single query
   Impact: Save 2-3 seconds

4. NO TOWNSHIP-LEVEL CACHING (MEDIUM IMPACT)
   Location: /pages/api/property-tax/analyze.ts:95-106
   Problem: getTownshipWinRate, getRecentSuccessfulAppeals called every time
           Same township analyzed 10x = same data fetched 10x
   Quick Fix: Cache township results with 7-day TTL
   Impact: 70% fewer API calls for multiple properties in same township

5. EXCESSIVE QUERY LIMITS (MEDIUM IMPACT)
   Location: Multiple - /lib/cook-county-api.ts:1050-1110, 1557
   Problem: Queries fetch 150+ records when only 10 needed
           BOR decisions: 5000 limit, then filter down to 10
   Quick Fix: Reduce limits - use limit*1.5 instead of limit*3
   Impact: 40-50% smaller API payloads

6. OUTDATED SALES DATA SOURCE (MEDIUM IMPACT)
   Location: /lib/cook-county-api.ts (getComparableSales)
   Problem: Using SALES_ARCHIVED dataset (2019 data) instead of PARCEL_SALES (current)
   Quick Fix: Switch to PARCEL_SALES (wvhk-k5uv) dataset
   Impact: Get 2024-2025 data + faster response

7. MULTIPLE PROPERTY LOOKUPS (MEDIUM IMPACT)
   Location: /lib/cook-county-api.ts:697-725
   Problem: getPropertyByPin queries 3 datasets in parallel to same external API
   Quick Fix: Check lookup cache first, use smarter dataset selection
   Impact: Save 1-5 seconds on first lookup

8. NO CIRCUIT BREAKER PATTERN (HIGH IMPACT)
   Location: /lib/cook-county-api.ts:628-683
   Problem: 45s timeout with 2 retries = 90+ second wait if API slow
           If Cook County API down, all queries wait 90s then fail
   Quick Fix: Reduce timeout to 20s, implement circuit breaker
   Impact: Fail fast on API outages, improve user experience

9. SEQUENTIAL ADDRESS GEOCODING (LOW-MEDIUM IMPACT)
   Location: /pages/api/property-tax/analyze.ts:95
   Problem: Comment indicates future geocoding call would happen after analysis
   Quick Fix: Pre-geocode during cache, store ward in property cache
   Impact: Prevent future bottleneck

10. REDUNDANT TOWNSHIP LOOKUPS (LOW IMPACT)
    Location: Multiple locations
    Problem: Township code looked up multiple times in same request
    Quick Fix: Cache township mapping in memory during request
    Impact: Marginal improvement

=== CALL FLOW BOTTLENECK BREAKDOWN ===

Sequential Operations Blocking Analysis:
├─ getComparableProperties (5 queries)      15-35s  <- MAIN BOTTLENECK
├─ getComparableSales (2-5 queries)         2-5s
├─ getPropertyByPin (3 queries)             2-8s
├─ getTownshipWinRate (1 large query)       2-5s    <- REPEATS
├─ getRecentSuccessfulAppeals (1 query)     2-5s    <- REPEATS
├─ getNeighborhoodConditions                1-3s    <- REPEATS
├─ checkExemptionEligibility                1-2s
├─ cacheComparables (N upserts)             2-3s    <- N+1 PROBLEM
└─ formatAnalysisResponse                   <1s

=== QUICK WINS (Low Effort, High Impact) ===

PRIORITY 1 - Do first (45 minutes total):
[ ] 1. Add analysis result caching (15 min) -> 40-50% latency reduction
[ ] 2. Batch upserts in cacheComparables (5 min) -> 2-3 seconds saved
[ ] 3. Add township-level caching (20 min) -> 70% fewer API calls

PRIORITY 2 - Do second (30 minutes total):
[ ] 4. Reduce API query limits (10 min) -> 40-50% smaller payloads
[ ] 5. Switch to PARCEL_SALES dataset (10 min) -> Current data
[ ] 6. Implement circuit breaker (45 min) -> Fail fast on outages

PRIORITY 3 - Do third (30 minutes total):
[ ] 7. Combine condo queries 2-4 (30 min) -> Save 10-20 seconds
[ ] 8. Pre-compute comparables (complex) -> Cache popular properties
[ ] 9. Add query pagination (medium) -> More efficient filtering

=== EXPECTED RESULTS AFTER OPTIMIZATION ===

Phase 1 (Quick Wins): 30-80s -> 20-50s (30-40% faster)
Phase 2 (Medium improvements): 20-50s -> 15-30s (additional 20-30% faster)
Phase 3 (Major refactoring): 15-30s -> 10-20s (additional 15-25% faster)

Total potential improvement: 40-60% latency reduction

=== FILES TO MODIFY ===

1. /pages/api/property-tax/analyze.ts
   - Add analysis caching (lines 71-122)
   - Batch upserts (lines 183-219)
   - Add township caching (lines 95-106)

2. /lib/cook-county-api.ts
   - Reduce query limits (multiple locations)
   - Switch to PARCEL_SALES (getComparableSales)
   - Combine condo queries (lines 1035-1136)
   - Add circuit breaker (lines 628-683)

3. /pages/api/property-tax/lookup.ts
   - Leverage existing cache (already partially implemented)

=== MONITORING TO ADD ===

Track latency by operation:
- console.time('SODA:dataset_name')
- metricsClient.increment('analysis.cache.hit/miss')
- console.time('property-tax-analyze')

Health checks:
- Cook County API endpoint status
- Cache hit rate by township
- API timeout rate by dataset

